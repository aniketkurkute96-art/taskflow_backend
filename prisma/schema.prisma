// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  email        String       @unique
  password     String
  role         String
  departmentId String?      @db.ObjectId
  department   Department?  @relation(fields: [departmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  createdTasks    Task[]           @relation("TaskCreator")
  assignedTasks   Task[]           @relation("TaskAssignee")
  taskNodesFrom   TaskNode[]       @relation("NodeFrom")
  taskNodesTo     TaskNode[]       @relation("NodeTo")
  taskApprovers   TaskApprover[]
  comments        Comment[]
  attachments     Attachment[]
  checklistItems  ChecklistItem[]
  activityLogs    ActivityLog[]

  @@map("users")
}

model Department {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  parentId  String?      @db.ObjectId
  parent    Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  Department[] @relation("DepartmentHierarchy")
  users     User[]
  tasks     Task[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("departments")
}

model Task {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  title              String
  description        String?
  creatorId          String             @db.ObjectId
  creator            User               @relation("TaskCreator", fields: [creatorId], references: [id])
  assigneeId         String?            @db.ObjectId
  assignee           User?              @relation("TaskAssignee", fields: [assigneeId], references: [id])
  assigneeType       String?
  departmentId       String?            @db.ObjectId
  department         Department?        @relation(fields: [departmentId], references: [id])
  amount             Float?
  approvalType       String
  approvalTemplateId String?            @db.ObjectId
  approvalTemplate   ApprovalTemplate?  @relation(fields: [approvalTemplateId], references: [id])
  status             String             @default("open")
  startDate          DateTime?
  dueDate            DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  nodes          TaskNode[]
  approvers      TaskApprover[]
  comments       Comment[]
  attachments    Attachment[]
  checklistItems ChecklistItem[]
  activityLogs   ActivityLog[]

  @@map("tasks")
}

model TaskNode {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId      String   @db.ObjectId
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  fromUserId  String   @db.ObjectId
  fromUser    User     @relation("NodeFrom", fields: [fromUserId], references: [id])
  toUserId    String   @db.ObjectId
  toUser      User     @relation("NodeTo", fields: [toUserId], references: [id])
  forwardedAt DateTime @default(now())

  @@map("task_nodes")
}

model TaskApprover {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  taskId         String    @db.ObjectId
  task           Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  levelOrder     Int
  approverUserId String    @db.ObjectId
  approver       User      @relation(fields: [approverUserId], references: [id])
  status         String    @default("pending")
  actionAt       DateTime?

  @@map("task_approvers")
}

model ApprovalTemplate {
  id            String                @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  conditionJson String                @default("{}")
  isActive      Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  tasks   Task[]
  stages  ApprovalTemplateStage[]

  @@map("approval_templates")
}

model ApprovalTemplateStage {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  templateId    String           @db.ObjectId
  template      ApprovalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  levelOrder    Int
  approverType  String
  approverValue String
  conditionJson String           @default("{}")

  @@map("approval_template_stages")
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String   @db.ObjectId
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  content   String
  createdAt DateTime @default(now())

  @@map("comments")
}

model Attachment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String   @db.ObjectId
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  filename  String
  filepath  String
  fileSize  Int?
  mimeType  String?
  createdAt DateTime @default(now())

  @@map("attachments")
}

model ChecklistItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String   @db.ObjectId
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  title     String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("checklist_items")
}

model ActivityLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId      String   @db.ObjectId
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String?  @db.ObjectId
  user        User?    @relation(fields: [userId], references: [id])
  action      String   // e.g., "created", "status_changed", "assigned", "commented", "attachment_added"
  description String   // Human-readable description
  oldValue    String?  // Previous value (for changes)
  newValue    String?  // New value (for changes)
  createdAt   DateTime @default(now())

  @@map("activity_logs")
}
